<?php

    require_once('DB.php');

    $db = new DB("127.0.0.1", "Projects206", "alexj", "Hancock10");

    if ($_SERVER['REQUEST_METHOD'] == "GET") {

        if($_GET['url'] == "get-students") {
						
			$students = $db->query('SELECT * FROM CollegeConnect_Users ORDER BY id DESC', array());
			
			$response = "[";
			
			foreach($students as $student) {
				
				$response.= "{";
					$response.= '"StudentId": '.$student['id'].',';
					$response.= '"Name": "'.$student['name'].'",';
					$response.= '"Email": "'.$student['email'].'",';
					$response.= '"College": "'.$student['college'].'",';
					$response.= '"Highschool": "'.$student['highschool'].'",';
					$response.= '"Display": "'.$student['display'].'",';
					$response.= '"Test": "'.$student['test'].'",';
					$response.= '"Score": "'.$student['score'].'",';
					$response.= '"STest": "'.$student['subject-test'].'",';
					$response.= '"Major": "'.$student['major'].'",';
					$response.= '"GPA": "'.$student['gpa'].'",';
					$response.= '"Rank": "'.$student['rank'].'",';
					$response.= '"Extra1": "'.$student['extra1'].'",';
					$response.= '"Extra2": "'.$student['extra2'].'",';
					$response.= '"Extra3": "'.$student['extra3'].'",';
					$response.= '"Classes": "'.$student['classes'].'",';
					$response.= '"Convince": "'.$student['convince'].'",';
					$response.= '"Dislikes": "'.$student['dislikes'].'",';
					$response.= '"Advice": "'.$student['advice'].'"';
				$response.= "},";
			
			}
			$response = substr($response, 0, strlen($response)-1);
			$response.= "]";
			
			echo($response);
			
		} else if($_GET['url'] == "get-student") {
						
			$student = $db->query('SELECT * FROM CollegeConnect_Users WHERE id=:id', array(':id'=>$_GET['student-id']));
				$response = "{";
					$response.= '"StudentId": "'.$student[0]['id'].'",';
					$response.= '"Name": "'.$student[0]['name'].'",';
					$response.= '"Email": "'.$student[0]['email'].'",';
					$response.= '"College": "'.$student[0]['college'].'",';
					$response.= '"Highschool": "'.$student[0]['highschool'].'",';
					$response.= '"Display": "'.$student[0]['display'].'",';
					$response.= '"Contact": "'.$student[0]['contact'].'",';
					$response.= '"Test": "'.$student[0]['test'].'",';
					$response.= '"Score": "'.$student[0]['score'].'",';
					$response.= '"STest": "'.$student[0]['subject-test'].'",';
					$response.= '"Major": "'.$student[0]['major'].'",';
					$response.= '"GPA": "'.$student[0]['gpa'].'",';
					$response.= '"Rank": "'.$student[0]['rank'].'",';
					$response.= '"Extra1": "'.$student[0]['extra1'].'",';
					$response.= '"Extra2": "'.$student[0]['extra2'].'",';
					$response.= '"Extra3": "'.$student[0]['extra3'].'",';
					$response.= '"Classes": "'.$student[0]['classes'].'",';
					$response.= '"Convince": "'.$student[0]['convince'].'",';
					$response.= '"Dislikes": "'.$student[0]['dislikes'].'",';
					$response.= '"Advice": "'.$student[0]['advice'].'"';
				$response.= "}";
		
			echo($response);
		} else if($_GET['url'] == "get-student-college-info") {
						
			$college = $db->query('SELECT college FROM CollegeConnect_Users WHERE id=:id', array(':id'=>$_GET['student-id']))[0]['college'];
			$studentgpa = $db->query('SELECT gpa FROM CollegeConnect_Users WHERE id=:id', array(':id'=>$_GET['student-id']))[0]['gpa'];
			$gpas = $db->query('SELECT gpa FROM CollegeConnect_Users WHERE college=:college', array(':college'=>$college));
			
			$i = 0;
			$response = "{";
			foreach ($gpas as $gpa) {
				$response.= '"'.$i.'": '.$gpa[0].',';
				$i++;
			}
			$response.= '"Student": '.$studentgpa.'';
			$response.= "}";
		
			echo($response);
		} else if($_GET['url'] == "get-student-college-info-test") {
			
			$test = $db->query('SELECT test FROM CollegeConnect_Users WHERE id=:id', array(':id'=>$_GET['student-id']))[0]['test'];
			$college = $db->query('SELECT college FROM CollegeConnect_Users WHERE id=:id', array(':id'=>$_GET['student-id']))[0]['college'];
			$studentscore = $db->query('SELECT score FROM CollegeConnect_Users WHERE id=:id', array(':id'=>$_GET['student-id']))[0]['score'];
			if($test == "ACT") {
				$scores = $db->query('SELECT score FROM CollegeConnect_Users WHERE college=:college AND test=:test', array(':college'=>$college, ':test'=>"ACT"));
				$i = 0;
				$response = "{";
				foreach ($scores as $score) {
					$response.= '"'.$i.'": '.$score[0].',';
					$i++;
				}
				$response.= '"Student": '.$studentscore.'';
				$response.= "}";
			} else {
				$scores = $db->query('SELECT score FROM CollegeConnect_Users WHERE college=:college AND test=:test', array(':college'=>$college, ':test'=>"SAT"));
				$i = 0;
				$response = "{";
				foreach ($scores as $score) {
					$response.= '"'.$i.'": '.$score[0].',';
					$i++;
				}
				$response.= '"Student": '.$studentscore.'';
				$response.= "}";
			}
		}

    } else if ($_SERVER['REQUEST_METHOD'] == "POST") {

        $postBody = file_get_contents("php://input");
        $postBody = json_decode($postBody);
    
        $name = $postBody->name;
		$email = $postBody->email;
		$college = $postBody->college;
		$highschool = $postBody->highschool;
        $display_pinfo = $postBody->display_pinfo;
		$contact = $postBody->contact;
        $test = $postBody->test;
        $score = $postBody->score;
        $stest = $postBody->stest;
        $major = $postBody->major;
        $gpa = $postBody->gpa;
        $rank = $postBody->rank;
        $extra1 = $postBody->extra1;
        $extra2 = $postBody->extra2;
        $extra3 = $postBody->extra3;
        $classes = $postBody->classes;
        $convince = $postBody->convince;
        $dislikes = $postBody->dislikes;
        $advice = $postBody->advice;

		if(trim($name) != "") {
			if(trim($email) != "") {
				if(trim($college) != "") {
					if(trim($test) != "---------") {
						if(trim($gpa) != "") {
							if(trim($rank) != "") {
								if(trim($major) != "") {
									if(trim($highschool) != "") {
										
										if($gpa > 5) {
											$gpa = ($gpa / 20) - 1;
										}
										
										
										echo 
										"
										Name: $name 
										Email: $email 
										College: $college
										Highschool: $highschool
										Display: $display_pinfo 
										Contact: $contact
										Test: $test 
										Score: $score 
										Subject Test: $stest 
										Major: $major 
										GPA: $gpa 
										Rank: $rank 
										Extra1: $extra1 
										Extra2: $extra2 
										Extra3: $extra3 
										Classes: $classes 
										Convince: $convince 
										Dislikes: $dislikes 
										Advice: $advice 
										";
										
										$db->query('INSERT INTO CollegeConnect_Users VALUES (\'\', :name, :email, :college, :hs, :display, :contact, :test, :score, :stest, :major, :gpa, :rank, :extra1, :extra2, :extra3, :classes, :convince, :dislikes, :advice)', array(':name'=>$name, ':email'=>$email, ':college'=>$college, ':hs'=>$highschool, ':display'=>$display_pinfo, ':contact'=>$contact, ':test'=>$test, ':score'=>$score, ':stest'=>$stest, ':major'=>$major, ':gpa'=>$gpa, ':rank'=>$rank, ':extra1'=>$extra1, ':extra2'=>$extra2, ':extra3'=>$extra3, ':classes'=>$classes, ':convince'=>$convince, ':dislikes'=>$dislikes, ':advice'=>$advice));
						
									} else {
										echo '{"Error": "Highschool field is required!"}';
										http_response_code(401);
									}
								} else {
									echo '{"Error": "Major field is required!"}';
									http_response_code(401);
								}
							} else {
								echo '{"Error": "Rank field is required!"}';
								http_response_code(401);
							}
						} else {
							echo '{"Error": "GPA field is required!"}';
							http_response_code(401);
						}
					} else {
						echo '{"Error": "Test field is required!"}';
						http_response_code(401);
					}
				} else {
					echo '{"Error": "College field is required!"}';
					http_response_code(401);
				}
			} else {
				echo '{"Error": "Email field is required!"}';
				http_response_code(401);
			}
		} else {
			echo '{"Error": "Name field is required!"}';
			http_response_code(401);
		}

        if ($_GET['url'] == "send") {
            
        }

    }
?>
